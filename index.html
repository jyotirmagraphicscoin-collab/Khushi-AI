<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Khushi - Your 3D Friend</title>
    <style>
        body { margin: 0; background-color: black; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        canvas { display: block; }

        /* Pink & White UI Theme */
        #ui-container {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            text-align: center; width: 90%; max-width: 400px; z-index: 10;
        }
        #chat-box {
            background: rgba(255, 255, 255, 0.9); color: #d63384;
            padding: 15px; border-radius: 20px; margin-bottom: 15px;
            font-weight: bold; min-height: 50px; border: 3px solid #ff85a2;
            box-shadow: 0 4px 15px rgba(255, 133, 162, 0.5);
        }
        #talk-btn {
            background-color: #ff85a2; color: white; border: none;
            padding: 12px 25px; border-radius: 30px; font-size: 18px;
            cursor: pointer; transition: 0.3s; font-weight: bold;
            box-shadow: 0 4px 10px rgba(255, 133, 162, 0.3);
        }
        #talk-btn:hover { background-color: #f73378; transform: scale(1.05); }
        #status { font-size: 12px; margin-top: 5px; color: #ff85a2; }
    </style>
</head>
<body>

    <div id="ui-container">
        <div id="chat-box">Namaste! Main Khushi hoon.</div>
        <button id="talk-btn">Khushi se Baat Karein</button>
        <div id="status">Ready to talk...</div>
    </div>

    <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.154.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.154.0/examples/jsm/",
                "@pixiv/three-vrm": "https://unpkg.com/@pixiv/three-vrm@2.0.0/lib/three-vrm.module.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';

        let currentVrm, mixer, currentSpeech;

        // --- Scene Setup ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(30, window.innerWidth / window.innerHeight, 0.1, 20);
        camera.position.set(0, 1.4, 3);

        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 1.5);
        light.position.set(1, 1, 1).normalize();
        scene.add(light);
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));

        // --- Load MODEL.vrm ---
        const loader = new GLTFLoader();
        loader.register((parser) => new VRMLoaderPlugin(parser));

        loader.load(
            './MODEL.vrm', // File location
            (gltf) => {
                const vrm = gltf.userData.vrm;
                VRMUtils.removeUnusedMeshes(gltf.scene);
                currentVrm = vrm;
                vrm.scene.rotation.y = 0; // Faces the user
                scene.add(vrm.scene);
                console.log("Khushi Loaded!");
            },
            (progress) => console.log('Loading...', (progress.loaded / progress.total * 100), '%'),
            (error) => console.error(error)
        );

        // --- Animations (Blink & Breathe) ---
        const clock = new THREE.Clock();
        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            const elapsed = clock.elapsedTime;

            if (currentVrm) {
                // Idle Breathing
                currentVrm.humanoid.getNormalizedBoneNode('chest').rotation.x = Math.sin(elapsed) * 0.02;
                
                // Auto Blinking
                const blinkStrength = Math.max(0, Math.sin(elapsed * 2) > 0.98 ? 1 : 0);
                currentVrm.expressionManager.setValue('blink', blinkStrength);

                // Simple Lip-sync when speaking
                if (window.isSpeaking) {
                    currentVrm.expressionManager.setValue('aa', Math.abs(Math.sin(elapsed * 15)) * 0.7);
                } else {
                    currentVrm.expressionManager.setValue('aa', 0);
                }

                currentVrm.update(delta);
            }
            renderer.render(scene, camera);
        }
        animate();

        // --- The Brain (Logic) ---
        function getBrainResponse(userInput) {
            userInput = userInput.toLowerCase();
            
            // Advanced Local Logic (Best Friend Style)
            if (userInput.includes('kaise ho') || userInput.includes('how are you')) {
                return "Main bahut acchi hoon! Aapne pucha toh aur bhi khush ho gayi. Aap kaise ho?";
            } else if (userInput.includes('naam') || userInput.includes('name')) {
                return "Mera naam Khushi hai, aur main aapki best friend banna chahti hoon.";
            } else if (userInput.includes('khana') || userInput.includes('eat')) {
                return "Mujhe toh digital data pasand hai, par suna hai Indian food bahut swadisht hota hai!";
            } else {
                return "Ye toh kaafi interesting baat hai! Is baare mein mujhe thoda aur batao?";
            }
        }

        // --- Speech & Voice Logic ---
        const talkBtn = document.getElementById('talk-btn');
        const chatBox = document.getElementById('chat-box');
        const status = document.getElementById('status');

        const Recognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!Recognition) {
            alert("Aapka browser Speech Recognition support nahi karta. Chrome use karein.");
        } else {
            const recognition = new Recognition();
            recognition.lang = 'hi-IN';

            talkBtn.onclick = () => {
                recognition.start();
                status.innerText = "Listening...";
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                chatBox.innerText = "You: " + transcript;
                
                const response = getBrainResponse(transcript);
                speak(response);
            };
        }

        function speak(text) {
            window.isSpeaking = true;
            status.innerText = "Khushi is speaking...";
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'hi-IN';
            utterance.rate = 1.0;
            
            utterance.onend = () => {
                window.isSpeaking = false;
                status.innerText = "Ready to talk...";
            };

            window.speechSynthesis.speak(utterance);
            chatBox.innerText = "Khushi: " + text;
        }

        // Resize handling
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
